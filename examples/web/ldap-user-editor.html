<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LDAP User Editor Demo</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Shared CSS -->
    <link rel="stylesheet" href="/static/browser/common-demo.css" />

    <!-- Library CSS -->
    <link rel="stylesheet" href="/static/browser/ldap-user-editor.css" />

    <style>
      :root {
        --primary-color: #6200ee;
        --primary-color-dark: #4a00b8;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .demo-header h1 {
        color: #6200ee;
      }

      .action-button {
        background: var(--primary-color);
      }

      .action-button:hover {
        background: var(--primary-color-dark);
      }
    </style>
  </head>
  <body>
    <div class="demo-container">
      <div class="demo-header">
        <h1>✏️ LDAP User Editor</h1>
        <p>Browse and edit LDAP users with schema-driven forms</p>
        <div class="action-buttons">
          <button class="action-button" id="create-user-btn" disabled>
            <span class="material-icons">person_add</span>
            Create User
          </button>
        </div>
      </div>

      <div id="status-container"></div>

      <div id="ldap-user-editor"></div>
    </div>

    <!-- Create User Modal -->
    <div class="modal-overlay" id="create-user-modal">
      <div class="modal">
        <div class="modal-header">
          <h2>Create New User</h2>
          <button class="close-button" id="close-modal-btn">
            <span class="material-icons">close</span>
          </button>
        </div>
        <form id="create-user-form">
          <div id="form-fields"></div>
          <div class="modal-footer">
            <button type="button" class="secondary" id="cancel-btn">
              Cancel
            </button>
            <button type="submit" class="primary">Create User</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Shared utilities -->
    <script src="/static/browser/shared.js"></script>
    <!-- Library JS -->
    <script src="/static/browser/ldap-user-editor.js"></script>

    <script>
      const { LdapUserEditor } = window.LdapUserEditor;
      const {
        escapeHtml,
        showStatus,
        generateFormField,
        processFormData,
        loadPointerOptions,
        replaceSchemaPlaceholders,
        getOrganizationPath,
      } = window.MiniDmShared;

      let editor;
      let userSchema;

      async function generateCreateUserForm() {
        const config = editor.getConfig();
        if (!config || !config.features?.flatResources) {
          throw new Error('Configuration not loaded');
        }

        // Get selected organization
        const currentOrgDn = editor.getCurrentOrgDn();
        if (!currentOrgDn) {
          throw new Error('No organization selected');
        }

        // Find users resource
        const usersResource = config.features.flatResources.find(
          r => r.pluralName === 'users' || r.name === 'users'
        );

        if (!usersResource) {
          throw new Error('Users resource not found in configuration');
        }

        // Load schema
        if (usersResource.schemaUrl) {
          const response = await fetch(usersResource.schemaUrl);
          if (!response.ok) throw new Error('Failed to load schema');
          userSchema = await response.json();
        } else if (usersResource.schema) {
          userSchema = usersResource.schema;
        } else {
          throw new Error('No schema available for users');
        }

        // Get organization path for twakeDepartmentPath
        const orgPath = await getOrganizationPath(currentOrgDn, window.location.origin);

        // Replace placeholders in schema branches
        const ldapBase = editor.getConfig().ldapBase;
        userSchema = replaceSchemaPlaceholders(userSchema, {
          __LDAP_BASE__: ldapBase,
          __ldap_base__: ldapBase,
        });

        // Generate form fields from schema
        const formFields = document.getElementById('form-fields');
        let fieldsHtml = '';

        // Add objectClass as hidden field
        const objectClasses = userSchema.entity.objectClass || [];
        fieldsHtml += objectClasses
          .map(oc => `<input type="hidden" name="objectClass" value="${oc}" />`)
          .join('');

        // API loader for pointer options
        const pointerLoader = async (branch) => {
          const api = editor.getApi();
          return await api.getPointerOptions(branch);
        };

        // Generate fields for all non-fixed attributes
        for (const [fieldName, attribute] of Object.entries(
          userSchema.attributes
        )) {
          if (attribute.fixed) continue; // Skip fixed fields like 'dn'
          if (fieldName === 'objectClass') continue; // Already handled

          // Auto-fill twakeDepartmentLink and twakeDepartmentPath
          if (fieldName === 'twakeDepartmentLink') {
            fieldsHtml += `
              <input type="hidden" name="twakeDepartmentLink" value="${escapeHtml(currentOrgDn)}" />
            `;
            continue;
          }

          if (fieldName === 'twakeDepartmentPath') {
            fieldsHtml += `
              <input type="hidden" name="twakeDepartmentPath" value="${escapeHtml(orgPath)}" />
            `;
            continue;
          }

          fieldsHtml += await generateFormField(fieldName, attribute, {
            pointerOptionsLoader: pointerLoader,
          });
        }

        formFields.innerHTML = fieldsHtml;

        // Attach handlers for pointer array fields
        attachPointerArrayHandlers();
      }

      function attachPointerArrayHandlers() {
        const modal = document.getElementById('create-user-modal');
        const api = editor.getApi();

        // Add button handlers for pointer arrays
        modal.querySelectorAll('.add-pointer-item').forEach(btn => {
          btn.addEventListener('click', async () => {
            const fieldName = btn.getAttribute('data-field');
            const container = btn.closest('.pointer-array-field');
            const branch = container.getAttribute('data-branch');

            if (!branch) return;

            // Load options using shared utility
            const options = await loadPointerOptions(branch, async (b) => {
              return await api.getPointerOptions(b);
            });

            // Create new select element
            const itemHtml = `
              <div class="array-item" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <select class="form-select pointer-array-select" data-field="${escapeHtml(fieldName)}" style="flex: 1;">
                  <option value="">Select...</option>
                  ${options
                    .map(
                      opt => `
                    <option value="${escapeHtml(opt.dn)}">${escapeHtml(opt.label)}</option>
                  `
                    )
                    .join('')}
                </select>
                <button type="button" class="btn btn-secondary btn-icon remove-pointer-item" style="padding: 8px;">
                  <span class="material-icons">remove</span>
                </button>
              </div>
            `;

            // Insert before the add button (XSS-safe: all user data escaped via escapeHtml)
            btn.insertAdjacentHTML('beforebegin', itemHtml);

            // Reattach handlers
            attachPointerArrayHandlers();
          });
        });

        // Remove button handlers
        modal.querySelectorAll('.remove-pointer-item').forEach(btn => {
          btn.addEventListener('click', () => {
            btn.closest('.array-item').remove();
          });
        });
      }

      function openCreateUserModal() {
        const modal = document.getElementById('create-user-modal');
        generateCreateUserForm()
          .then(() => {
            modal.classList.add('active');
          })
          .catch(error => {
            console.error('Failed to generate form:', error);
            showStatus('status-container', `Error: ${error.message}`, 'error');
          });
      }

      function closeCreateUserModal() {
        const modal = document.getElementById('create-user-modal');
        modal.classList.remove('active');
        document.getElementById('create-user-form').reset();
      }

      async function handleCreateUser(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);

        // Process pointer array fields (manually collect from selects)
        const modal = document.getElementById('create-user-modal');
        modal.querySelectorAll('.pointer-array-field').forEach(container => {
          const fieldName = container.getAttribute('data-field');
          const selects = container.querySelectorAll('.pointer-array-select');
          const values = Array.from(selects)
            .map(select => select.value)
            .filter(val => val); // Remove empty values

          if (values.length > 0) {
            // Add all values to formData
            values.forEach(val => formData.append(fieldName, val));
          }
        });

        // Use shared utility to process form data
        const userData = processFormData(formData, userSchema.attributes);

        console.log('Creating user with data:', userData);

        try {
          await editor.createUser(userData);
          showStatus('status-container', 'User created successfully!', 'success');
          closeCreateUserModal();
        } catch (error) {
          console.error('Failed to create user:', error);
          const errorMessage = error.message || error.toString();
          showStatus('status-container', `Error: ${errorMessage}`, 'error');
        }
      }

      async function handleDeleteUser() {
        const userDn = editor.getCurrentUserDn();
        if (!userDn) {
          showStatus('status-container', 'No user selected', 'error');
          return;
        }

        if (
          !confirm(`Are you sure you want to delete this user?\n\n${userDn}`)
        ) {
          return;
        }

        try {
          await editor.deleteUser(userDn);
          showStatus('status-container', 'User deleted successfully!', 'success');

          // Disable delete button
          document.getElementById('delete-user-btn').disabled = true;
        } catch (error) {
          console.error('Failed to delete user:', error);
          showStatus('status-container', `Error: ${error.message}`, 'error');
        }
      }

      async function initEditor() {
        try {
          editor = new LdapUserEditor({
            containerId: 'ldap-user-editor',
            apiBaseUrl: window.location.origin,
            onUserSaved: userDn => {
              console.log('User saved:', userDn);
              showStatus('status-container', 'User saved successfully!', 'success');
            },
            onError: error => {
              console.error('Editor error:', error);
              showStatus('status-container', `Error: ${error.message}`, 'error');
            },
          });

          await editor.init();
          showStatus('status-container', 'LDAP User Editor loaded successfully!', 'success');

          // Enable/disable buttons based on selection
          setInterval(() => {
            const createBtn = document.getElementById('create-user-btn');
            const currentOrgDn = editor.getCurrentOrgDn();

            createBtn.disabled = !currentOrgDn;
          }, 500);
        } catch (error) {
          console.error('Failed to initialize editor:', error);
          showStatus('status-container', `Error: ${error.message}`, 'error');
        }
      }

      // Event listeners
      document
        .getElementById('create-user-btn')
        .addEventListener('click', openCreateUserModal);
      document
        .getElementById('close-modal-btn')
        .addEventListener('click', closeCreateUserModal);
      document
        .getElementById('cancel-btn')
        .addEventListener('click', closeCreateUserModal);
      document
        .getElementById('create-user-form')
        .addEventListener('submit', handleCreateUser);

      // Close modal when clicking outside
      document
        .getElementById('create-user-modal')
        .addEventListener('click', e => {
          if (e.target.id === 'create-user-modal') {
            closeCreateUserModal();
          }
        });

      // Initialize on load
      initEditor();
    </script>
  </body>
</html>

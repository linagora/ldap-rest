<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LDAP User Editor Demo</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Library CSS -->
    <link rel="stylesheet" href="/static/browser/ldap-user-editor.css" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Roboto', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 24px;
      }

      .demo-container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .demo-header {
        background: white;
        color: #333;
        padding: 32px;
        margin-bottom: 24px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .demo-header h1 {
        font-size: 32px;
        font-weight: 500;
        margin-bottom: 8px;
        color: #6200ee;
      }

      .demo-header p {
        font-size: 16px;
        color: #666;
      }

      #ldap-user-editor {
        /* The editor library will add its own styling */
      }

      .status-message {
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-message.error {
        background: #ffebee;
        color: #c62828;
      }

      .status-message.success {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 16px;
      }

      .action-button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        background: #6200ee;
        color: white;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
      }

      .action-button:hover {
        background: #4a00b8;
      }

      .action-button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .action-button.danger {
        background: #d32f2f;
      }

      .action-button.danger:hover {
        background: #b71c1c;
      }

      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: white;
        border-radius: 8px;
        padding: 24px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .modal-header h2 {
        font-size: 24px;
        font-weight: 500;
        color: #333;
        margin: 0;
      }

      .close-button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 24px;
        color: #666;
        padding: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }

      .close-button:hover {
        background: #f0f0f0;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .form-group label.required::after {
        content: ' *';
        color: #d32f2f;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: 'Roboto', sans-serif;
      }

      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #6200ee;
      }

      .form-select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: 'Roboto', sans-serif;
        background-color: white;
        cursor: pointer;
      }

      .form-select:focus {
        outline: none;
        border-color: #6200ee;
      }

      .array-field {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .array-item {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: background 0.2s;
      }

      .btn-secondary {
        background: #f0f0f0;
        color: #333;
      }

      .btn-secondary:hover {
        background: #e0e0e0;
      }

      .btn-icon {
        padding: 8px;
        min-width: auto;
      }

      .btn .material-icons {
        font-size: 18px;
      }

      .form-group .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      .modal-footer button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }

      .modal-footer button.primary {
        background: #6200ee;
        color: white;
      }

      .modal-footer button.primary:hover {
        background: #4a00b8;
      }

      .modal-footer button.secondary {
        background: #f0f0f0;
        color: #333;
      }

      .modal-footer button.secondary:hover {
        background: #e0e0e0;
      }
    </style>
  </head>
  <body>
    <div class="demo-container">
      <div class="demo-header">
        <h1>✏️ LDAP User Editor</h1>
        <p>Browse and edit LDAP users with schema-driven forms</p>
        <div class="action-buttons">
          <button class="action-button" id="create-user-btn" disabled>
            <span class="material-icons">person_add</span>
            Create User
          </button>
          <button class="action-button danger" id="delete-user-btn" disabled>
            <span class="material-icons">person_remove</span>
            Delete User
          </button>
        </div>
      </div>

      <div id="status-container"></div>

      <div id="ldap-user-editor"></div>
    </div>

    <!-- Create User Modal -->
    <div class="modal-overlay" id="create-user-modal">
      <div class="modal">
        <div class="modal-header">
          <h2>Create New User</h2>
          <button class="close-button" id="close-modal-btn">
            <span class="material-icons">close</span>
          </button>
        </div>
        <form id="create-user-form">
          <div id="form-fields"></div>
          <div class="modal-footer">
            <button type="button" class="secondary" id="cancel-btn">
              Cancel
            </button>
            <button type="submit" class="primary">Create User</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Library JS -->
    <script src="/static/browser/ldap-user-editor.js"></script>

    <script>
      const { LdapUserEditor } = window.LdapUserEditor;

      let editor;
      let userSchema;
      let pointerOptionsCache = {};

      function showStatus(message, type = 'error') {
        const container = document.getElementById('status-container');
        container.innerHTML = `
        <div class="status-message ${type}">
          <span class="material-icons">${type === 'error' ? 'error_outline' : 'check_circle'}</span>
          <span>${message}</span>
        </div>
      `;
        setTimeout(() => {
          container.innerHTML = '';
        }, 5000);
      }

      function getFieldLabel(fieldName, attribute) {
        // Convert camelCase or snake_case to Title Case
        const label = fieldName.replace(/([A-Z])/g, ' $1').replace(/_/g, ' ');
        return label.charAt(0).toUpperCase() + label.slice(1);
      }

      async function loadPointerOptions(branch) {
        if (pointerOptionsCache[branch]) {
          return pointerOptionsCache[branch];
        }

        try {
          const api = editor.getApi();
          const options = await api.getPointerOptions(branch);
          pointerOptionsCache[branch] = options;
          return options;
        } catch (error) {
          console.error(
            'Failed to load pointer options for branch:',
            branch,
            error
          );
          return [];
        }
      }

      async function generateFormField(fieldName, attribute) {
        const label = getFieldLabel(fieldName, attribute);
        const required = attribute.required ? 'required' : '';
        const labelClass = attribute.required ? 'required' : '';

        let fieldHtml = '';

        if (attribute.type === 'pointer') {
          // Pointer field - load options and display select
          const branch = attribute.branch?.[0];
          if (branch) {
            const options = await loadPointerOptions(branch);
            fieldHtml = `
              <div class="form-group">
                <label for="${fieldName}" class="${labelClass}">${label}</label>
                <select id="${fieldName}" name="${fieldName}" class="form-select" ${required}>
                  <option value="">Select...</option>
                  ${options
                    .map(
                      opt => `
                    <option value="${opt.dn}">${opt.label}</option>
                  `
                    )
                    .join('')}
                </select>
              </div>
            `;
          } else {
            // Fallback if no branch defined
            fieldHtml = `
              <div class="form-group">
                <label for="${fieldName}" class="${labelClass}">${label}</label>
                <input type="text" id="${fieldName}" name="${fieldName}" ${required} />
                <div class="help-text">Enter DN (Distinguished Name)</div>
              </div>
            `;
          }
        } else if (
          attribute.type === 'array' &&
          attribute.items?.type === 'pointer'
        ) {
          // Array of pointers - load options and display multiple selects
          const branch = attribute.items.branch?.[0];
          if (branch) {
            const options = await loadPointerOptions(branch);
            fieldHtml = `
              <div class="form-group">
                <label class="${labelClass}">${label}</label>
                <div class="array-field pointer-array-field" data-field="${fieldName}" data-branch="${branch}">
                  <button type="button" class="btn btn-secondary add-pointer-item" data-field="${fieldName}">
                    <span class="material-icons">add</span>
                    Add ${label}
                  </button>
                </div>
                <input type="hidden" name="${fieldName}" id="${fieldName}-hidden" value="" />
              </div>
            `;
          } else {
            // Fallback
            fieldHtml = `
              <div class="form-group">
                <label for="${fieldName}" class="${labelClass}">${label}</label>
                <textarea id="${fieldName}" name="${fieldName}" ${required}></textarea>
                <div class="help-text">Enter one DN per line</div>
              </div>
            `;
          }
        } else if (
          attribute.type === 'array' &&
          attribute.items?.type === 'string'
        ) {
          // Array field - use textarea
          fieldHtml = `
            <div class="form-group">
              <label for="${fieldName}" class="${labelClass}">${label}</label>
              <textarea id="${fieldName}" name="${fieldName}" ${required}></textarea>
              <div class="help-text">Enter one value per line</div>
            </div>
          `;
        } else if (
          attribute.type === 'number' ||
          attribute.type === 'integer'
        ) {
          // Number field
          fieldHtml = `
            <div class="form-group">
              <label for="${fieldName}" class="${labelClass}">${label}</label>
              <input type="number" id="${fieldName}" name="${fieldName}" ${required} />
            </div>
          `;
        } else if (attribute.type === 'string') {
          // String field - use input
          const type =
            fieldName.toLowerCase().includes('password') ||
            fieldName.toLowerCase().includes('pwd')
              ? 'password'
              : fieldName.toLowerCase().includes('mail')
                ? 'email'
                : 'text';
          fieldHtml = `
            <div class="form-group">
              <label for="${fieldName}" class="${labelClass}">${label}</label>
              <input type="${type}" id="${fieldName}" name="${fieldName}" ${required} />
            </div>
          `;
        }

        return fieldHtml;
      }

      async function getOrganizationPath(orgDn) {
        try {
          const response = await fetch(
            `${window.location.origin}/api/v1/ldap/organizations/${encodeURIComponent(orgDn)}`
          );
          if (!response.ok) {
            console.error('Failed to fetch organization:', response.status);
            return orgDn;
          }
          const org = await response.json();

          // Use twakeDepartmentPath if available (Twake schema)
          if (org.twakeDepartmentPath) {
            const pathValue = Array.isArray(org.twakeDepartmentPath)
              ? org.twakeDepartmentPath[0]
              : org.twakeDepartmentPath;
            return pathValue;
          }

          // Fallback to ou name for non-Twake schemas
          if (org.ou) {
            const ouValue = Array.isArray(org.ou) ? org.ou[0] : org.ou;
            return ouValue;
          }

          // Last resort: use DN
          return orgDn;
        } catch (error) {
          console.error('Failed to get organization info:', error);
          return orgDn;
        }
      }

      async function generateCreateUserForm() {
        const config = editor.getConfig();
        if (!config || !config.features?.flatResources) {
          throw new Error('Configuration not loaded');
        }

        // Get selected organization
        const currentOrgDn = editor.getCurrentOrgDn();
        if (!currentOrgDn) {
          throw new Error('No organization selected');
        }

        // Find users resource
        const usersResource = config.features.flatResources.find(
          r => r.pluralName === 'users' || r.name === 'users'
        );

        if (!usersResource) {
          throw new Error('Users resource not found in configuration');
        }

        // Load schema
        if (usersResource.schemaUrl) {
          const response = await fetch(usersResource.schemaUrl);
          if (!response.ok) throw new Error('Failed to load schema');
          userSchema = await response.json();
        } else if (usersResource.schema) {
          userSchema = usersResource.schema;
        } else {
          throw new Error('No schema available for users');
        }

        // Get organization path for twakeDepartmentPath
        const orgPath = await getOrganizationPath(currentOrgDn);

        // Replace placeholders in schema branches
        const ldapBase = editor.getConfig().ldapBase;
        for (const attr of Object.values(userSchema.attributes)) {
          if (attr.branch) {
            attr.branch = attr.branch.map(b =>
              b
                .replace(/__LDAP_BASE__/g, ldapBase)
                .replace(/__ldap_base__/g, ldapBase)
            );
          }
          if (attr.items?.branch) {
            attr.items.branch = attr.items.branch.map(b =>
              b
                .replace(/__LDAP_BASE__/g, ldapBase)
                .replace(/__ldap_base__/g, ldapBase)
            );
          }
        }

        // Generate form fields from schema
        const formFields = document.getElementById('form-fields');
        let fieldsHtml = '';

        // Add objectClass as hidden field
        const objectClasses = userSchema.entity.objectClass || [];
        fieldsHtml += objectClasses
          .map(oc => `<input type="hidden" name="objectClass" value="${oc}" />`)
          .join('');

        // Generate fields for all non-fixed attributes
        for (const [fieldName, attribute] of Object.entries(
          userSchema.attributes
        )) {
          if (attribute.fixed) continue; // Skip fixed fields like 'dn'
          if (fieldName === 'objectClass') continue; // Already handled

          // Auto-fill twakeDepartmentLink and twakeDepartmentPath
          if (fieldName === 'twakeDepartmentLink') {
            fieldsHtml += `
              <input type="hidden" name="twakeDepartmentLink" value="${currentOrgDn}" />
            `;
            continue;
          }

          if (fieldName === 'twakeDepartmentPath') {
            fieldsHtml += `
              <input type="hidden" name="twakeDepartmentPath" value="${orgPath}" />
            `;
            continue;
          }

          fieldsHtml += await generateFormField(fieldName, attribute);
        }

        formFields.innerHTML = fieldsHtml;

        // Attach handlers for pointer array fields
        attachPointerArrayHandlers();
      }

      function attachPointerArrayHandlers() {
        const modal = document.getElementById('create-user-modal');

        // Add button handlers for pointer arrays
        modal.querySelectorAll('.add-pointer-item').forEach(btn => {
          btn.addEventListener('click', async () => {
            const fieldName = btn.getAttribute('data-field');
            const container = btn.closest('.pointer-array-field');
            const branch = container.getAttribute('data-branch');

            if (!branch) return;

            // Load options if not cached
            const options = await loadPointerOptions(branch);

            // Create new select element
            const itemHtml = `
              <div class="array-item" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <select class="form-select pointer-array-select" data-field="${fieldName}" style="flex: 1;">
                  <option value="">Select...</option>
                  ${options
                    .map(
                      opt => `
                    <option value="${opt.dn}">${opt.label}</option>
                  `
                    )
                    .join('')}
                </select>
                <button type="button" class="btn btn-secondary btn-icon remove-pointer-item" style="padding: 8px;">
                  <span class="material-icons">remove</span>
                </button>
              </div>
            `;

            // Insert before the add button
            btn.insertAdjacentHTML('beforebegin', itemHtml);

            // Reattach handlers
            attachPointerArrayHandlers();
          });
        });

        // Remove button handlers
        modal.querySelectorAll('.remove-pointer-item').forEach(btn => {
          btn.addEventListener('click', () => {
            btn.closest('.array-item').remove();
          });
        });
      }

      function openCreateUserModal() {
        const modal = document.getElementById('create-user-modal');
        generateCreateUserForm()
          .then(() => {
            modal.classList.add('active');
          })
          .catch(error => {
            console.error('Failed to generate form:', error);
            showStatus(`Error: ${error.message}`, 'error');
          });
      }

      function closeCreateUserModal() {
        const modal = document.getElementById('create-user-modal');
        modal.classList.remove('active');
        document.getElementById('create-user-form').reset();
        // Clear pointer options cache when closing
        pointerOptionsCache = {};
      }

      async function handleCreateUser(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);
        const userData = {};

        // Process form data
        for (const [key, value] of formData.entries()) {
          if (userData[key]) {
            // Multiple values for the same key - convert to array
            if (!Array.isArray(userData[key])) {
              userData[key] = [userData[key]];
            }
            userData[key].push(value);
          } else {
            userData[key] = value;
          }
        }

        // Process pointer array fields (manually collect from selects)
        const modal = document.getElementById('create-user-modal');
        modal.querySelectorAll('.pointer-array-field').forEach(container => {
          const fieldName = container.getAttribute('data-field');
          const selects = container.querySelectorAll('.pointer-array-select');
          const values = Array.from(selects)
            .map(select => select.value)
            .filter(val => val); // Remove empty values

          if (values.length > 0) {
            userData[fieldName] = values;
          }
        });

        // Process special field types
        for (const [fieldName, attribute] of Object.entries(
          userSchema.attributes
        )) {
          if (!userData[fieldName]) continue;

          if (
            attribute.type === 'array' &&
            typeof userData[fieldName] === 'string'
          ) {
            // Split by newlines and filter empty lines
            userData[fieldName] = userData[fieldName]
              .split('\n')
              .map(line => line.trim())
              .filter(line => line.length > 0);
          } else if (
            attribute.type === 'number' ||
            attribute.type === 'integer'
          ) {
            // Convert to number
            userData[fieldName] =
              attribute.type === 'integer'
                ? parseInt(userData[fieldName], 10)
                : parseFloat(userData[fieldName]);
          }
        }

        // Clean up: remove empty strings and null values
        const cleanedData = {};
        for (const [key, value] of Object.entries(userData)) {
          if (value === '' || value === null || value === undefined) {
            continue; // Skip empty values
          }
          if (Array.isArray(value) && value.length === 0) {
            continue; // Skip empty arrays
          }
          cleanedData[key] = value;
        }

        console.log('Creating user with data:', cleanedData);

        try {
          await editor.createUser(cleanedData);
          showStatus('User created successfully!', 'success');
          closeCreateUserModal();
        } catch (error) {
          console.error('Failed to create user:', error);
          const errorMessage = error.message || error.toString();
          showStatus(`Error: ${errorMessage}`, 'error');
        }
      }

      async function handleDeleteUser() {
        const userDn = editor.getCurrentUserDn();
        if (!userDn) {
          showStatus('No user selected', 'error');
          return;
        }

        if (
          !confirm(`Are you sure you want to delete this user?\n\n${userDn}`)
        ) {
          return;
        }

        try {
          await editor.deleteUser(userDn);
          showStatus('User deleted successfully!', 'success');

          // Disable delete button
          document.getElementById('delete-user-btn').disabled = true;
        } catch (error) {
          console.error('Failed to delete user:', error);
          showStatus(`Error: ${error.message}`, 'error');
        }
      }

      async function initEditor() {
        try {
          editor = new LdapUserEditor({
            containerId: 'ldap-user-editor',
            apiBaseUrl: window.location.origin,
            onUserSaved: userDn => {
              console.log('User saved:', userDn);
              showStatus('User saved successfully!', 'success');
            },
            onError: error => {
              console.error('Editor error:', error);
              showStatus(`Error: ${error.message}`, 'error');
            },
          });

          await editor.init();
          showStatus('LDAP User Editor loaded successfully!', 'success');

          // Enable/disable buttons based on selection
          setInterval(() => {
            const createBtn = document.getElementById('create-user-btn');
            const deleteBtn = document.getElementById('delete-user-btn');
            const currentOrgDn = editor.getCurrentOrgDn();
            const currentUserDn = editor.getCurrentUserDn();

            createBtn.disabled = !currentOrgDn;
            deleteBtn.disabled = !currentUserDn;
          }, 500);
        } catch (error) {
          console.error('Failed to initialize editor:', error);
          showStatus(`Error: ${error.message}`, 'error');
        }
      }

      // Event listeners
      document
        .getElementById('create-user-btn')
        .addEventListener('click', openCreateUserModal);
      document
        .getElementById('delete-user-btn')
        .addEventListener('click', handleDeleteUser);
      document
        .getElementById('close-modal-btn')
        .addEventListener('click', closeCreateUserModal);
      document
        .getElementById('cancel-btn')
        .addEventListener('click', closeCreateUserModal);
      document
        .getElementById('create-user-form')
        .addEventListener('submit', handleCreateUser);

      // Close modal when clicking outside
      document
        .getElementById('create-user-modal')
        .addEventListener('click', e => {
          if (e.target.id === 'create-user-modal') {
            closeCreateUserModal();
          }
        });

      // Initialize on load
      initEditor();
    </script>
  </body>
</html>

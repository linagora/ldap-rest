<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LDAP Tree Viewer Demo</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Library CSS -->
    <!-- Shared CSS -->
    <link rel="stylesheet" href="/static/browser/common-demo.css" />

    <link rel="stylesheet" href="/static/browser/ldap-tree-viewer.css" />

    <style>
      :root {
        --primary-color: #6200ee;
        --primary-color-dark: #4a00b8;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .demo-header h1 {
        color: #6200ee;
      }
    </style>
  </head>
  <body>
    <div class="demo-container">
      <div class="demo-header">
        <h1>üìÅ LDAP Tree Viewer</h1>
        <p>Interactive visualization of LDAP directory structure</p>

        <div class="demo-controls">
          <button id="btn-refresh" class="demo-button">
            <span
              class="material-icons"
              style="vertical-align: middle; font-size: 18px"
              >refresh</span
            >
            Refresh
          </button>
          <button id="btn-expand" class="demo-button">Expand All</button>
          <button id="btn-collapse" class="demo-button">Collapse All</button>
        </div>
      </div>

      <div id="status-container"></div>

      <div class="demo-grid">
        <div class="demo-panel">
          <h2>
            <span class="material-icons">account_tree</span>
            Directory Tree
          </h2>
          <div id="ldap-tree"></div>
        </div>

        <div class="demo-panel">
          <h2>
            <span class="material-icons">info</span>
            Node Details
          </h2>
          <div id="node-details">
            <div class="details-empty">
              <span
                class="material-icons"
                style="font-size: 48px; color: #ddd; margin-bottom: 8px"
                >touch_app</span
              >
              <p>Click on a node to see details</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Library JS -->
    <!-- Shared utilities -->
    <script src="/static/browser/shared.js"></script>
    <script src="/static/browser/ldap-tree-viewer.js"></script>

    <script>
      const { LdapTreeViewer } = window.LdapTreeViewer;
      const { showStatus, escapeHtml } = window.MiniDmShared;

      let viewer;

      function renderNodeDetails(node) {
        const detailsEl = document.getElementById('node-details');

        // Special handling for 'more' indicator
        if (node.type === 'more') {
          const totalCount = node.attributes?._totalCount || '?';
          const displayedCount = node.attributes?._displayedCount || '?';
          const parentDn = node.parentDn;

          detailsEl.innerHTML = `
          <div class="details-content">
            <div class="details-header">
              <span class="material-icons" style="color: #ff9800">more_horiz</span>
              <h3>Additional Elements</h3>
            </div>

            <div class="details-info">
              <div class="details-row">
                <span class="details-label">Total elements:</span>
                <span class="details-value">${totalCount}</span>
              </div>
              <div class="details-row">
                <span class="details-label">Displayed:</span>
                <span class="details-value">${displayedCount}</span>
              </div>
              <div class="details-row">
                <span class="details-label">Hidden:</span>
                <span class="details-value">${parseInt(totalCount) - parseInt(displayedCount)}</span>
              </div>
            </div>

            <div style="margin-top: 24px; padding: 16px; background: #fff3e0; border-radius: 4px;">
              <h4 style="font-size: 14px; font-weight: 500; margin-bottom: 12px; color: #e65100;">
                üîç Search to find specific elements
              </h4>
              <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                There are too many elements to display at once. Use the search below to find specific users or groups.
              </p>
              <div style="display: flex; gap: 8px;">
                <input
                  type="text"
                  id="search-input"
                  placeholder="Search by name, uid, email..."
                  style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                  onkeypress="if(event.key === 'Enter') document.getElementById('search-btn').click()"
                />
                <button
                  id="search-btn"
                  class="demo-button"
                  style="margin: 0;"
                  onclick="performSearch('${parentDn}', document.getElementById('search-input').value)"
                >
                  Search
                </button>
              </div>
              <div id="search-results" style="margin-top: 12px;"></div>
            </div>
          </div>
        `;
          return;
        }

        const iconMap = {
          organization: { icon: 'folder', color: '#ffa726' },
          user: { icon: 'person', color: '#42a5f5' },
          group: { icon: 'group', color: '#66bb6a' },
        };

        const { icon, color } = iconMap[node.type] || {
          icon: 'help',
          color: '#999',
        };

        detailsEl.innerHTML = `
        <div class="details-content">
          <div class="details-header">
            <span class="material-icons" style="color: ${color}">${icon}</span>
            <h3>${node.displayName}</h3>
          </div>

          <div class="details-info">
            <div class="details-row">
              <span class="details-label">Type:</span>
              <span class="details-value">${node.type}</span>
            </div>
            <div class="details-row">
              <span class="details-label">DN:</span>
              <span class="details-value">${node.dn}</span>
            </div>
            <div class="details-row">
              <span class="details-label">Has Children:</span>
              <span class="details-value">${node.hasChildren ? 'Yes' : 'No'}</span>
            </div>
            ${
              node.parentDn
                ? `
              <div class="details-row">
                <span class="details-label">Parent DN:</span>
                <span class="details-value">${node.parentDn}</span>
              </div>
            `
                : ''
            }
          </div>

          ${
            node.attributes
              ? `
            <div class="details-attributes">
              <h4>Attributes</h4>
              <pre>${JSON.stringify(node.attributes, null, 2)}</pre>
            </div>
          `
              : ''
          }
        </div>
      `;
      }

      async function performSearch(parentDn, query) {
        if (!query || query.trim().length === 0) {
          document.getElementById('search-results').innerHTML =
            '<p style="color: #f44336; font-size: 13px;">Please enter a search query</p>';
          return;
        }

        const resultsEl = document.getElementById('search-results');
        resultsEl.innerHTML =
          '<p style="font-size: 13px; color: #666;">Searching...</p>';

        try {
          const response = await fetch(
            `${window.location.origin}/api/v1/ldap/organizations/${encodeURIComponent(parentDn)}/subnodes/search?q=${encodeURIComponent(query.trim())}`
          );

          if (!response.ok) {
            throw new Error(`Search failed: ${response.statusText}`);
          }

          const results = await response.json();

          if (results.length === 0) {
            resultsEl.innerHTML =
              '<p style="font-size: 13px; color: #999;">No results found</p>';
            return;
          }

          const resultHtml = results
            .map(item => {
              const name =
                (item.cn && item.cn[0]) ||
                (item.uid && item.uid[0]) ||
                (item.ou && item.ou[0]) ||
                'Unknown';
              const type = item.objectClass?.includes('organizationalUnit')
                ? 'organization'
                : item.objectClass?.includes('posixGroup') ||
                    item.objectClass?.includes('groupOfNames')
                  ? 'group'
                  : 'user';
              const icon =
                type === 'organization'
                  ? 'folder'
                  : type === 'group'
                    ? 'group'
                    : 'person';

              return `
            <div style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 8px;">
              <span class="material-icons" style="font-size: 18px; color: #666;">${icon}</span>
              <div style="flex: 1;">
                <div style="font-weight: 500; font-size: 13px;">${name}</div>
                <div style="font-size: 11px; color: #999;">${item.dn}</div>
              </div>
            </div>
          `;
            })
            .join('');

          resultsEl.innerHTML = `
          <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; margin-top: 8px;">
            <div style="padding: 8px; background: #f5f5f5; font-weight: 500; font-size: 13px; border-bottom: 2px solid #ddd;">
              Found ${results.length} result(s)
            </div>
            ${resultHtml}
          </div>
        `;
        } catch (error) {
          console.error('Search error:', error);
          resultsEl.innerHTML = `<p style="color: #f44336; font-size: 13px;">Error: ${error.message}</p>`;
        }
      }

      async function initViewer() {
        try {
          viewer = new LdapTreeViewer({
            containerId: 'ldap-tree',
            apiBaseUrl: window.location.origin,
            theme: 'light',
            onNodeClick: node => {
              console.log('Node clicked:', node);
              renderNodeDetails(node);
            },
            onNodeExpand: node => {
              console.log('Node expanded:', node.dn);
            },
          });

          await viewer.init();
          showStatus('status-container', 'LDAP tree loaded successfully!', 'success');
        } catch (error) {
          console.error('Failed to initialize viewer:', error);
          showStatus('status-container', `Error: ${error.message}`, 'error');
        }
      }

      // Button handlers
      document
        .getElementById('btn-refresh')
        .addEventListener('click', async () => {
          if (viewer) {
            try {
              await viewer.refresh();
              showStatus('status-container', 'Tree refreshed!', 'success');
            } catch (error) {
              showStatus('status-container', `Error: ${error.message}`, 'error');
            }
          }
        });

      document
        .getElementById('btn-expand')
        .addEventListener('click', async () => {
          if (viewer) {
            const state = viewer.getState();
            const promises = [];
            state.nodes.forEach((node, dn) => {
              if (node.hasChildren && !state.expandedNodes.has(dn)) {
                promises.push(viewer.expandNode(dn));
              }
            });
            await Promise.all(promises);
            showStatus('status-container', 'All nodes expanded!', 'success');
          }
        });

      document.getElementById('btn-collapse').addEventListener('click', () => {
        if (viewer) {
          const state = viewer.getState();
          state.expandedNodes.forEach(dn => {
            viewer.collapseNode(dn);
          });
          showStatus('status-container', 'All nodes collapsed!', 'success');
        }
      });

      // Initialize on load
      initViewer();
    </script>
  </body>
</html>
